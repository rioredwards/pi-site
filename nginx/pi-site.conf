# Nginx configuration for pi-site
# This file is copied to /etc/nginx/sites-available/pi-site by deploy.sh
#
# After modifying, either:
#   1. Re-run deploy.sh (will copy and reload nginx)
#   2. Manually: sudo cp nginx/pi-site.conf /etc/nginx/sites-available/pi-site && sudo nginx -t && sudo systemctl reload nginx

# Umami analytics dashboard subdomain
server {
    listen 80;
    server_name umami.rioedwards.com;

    # Proxy all requests to Umami (no path rewriting needed since it's a subdomain)
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Preserve original host/IP info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache_bypass $http_upgrade;
    }
}

# Main site
server {
    listen 80;
    server_name _;

    # Serve user-uploaded images directly from Docker volume
    # Bypasses Node.js for better performance
    location /api/assets/images/ {
        alias /var/lib/docker/volumes/pi_site_prod_uploads/_data/;

        # Aggressive caching for immutable uploaded images
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
        add_header Access-Control-Allow-Origin "*";

        # Performance optimizations
        access_log off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        try_files $uri =404;
    }

    # Proxy all requests to Next.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Preserve original host/IP info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache_bypass $http_upgrade;
    }
}
