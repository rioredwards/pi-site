# Nginx configuration for pi-site
# This file is copied to /etc/nginx/sites-available/pi-site by deploy.sh
#
# After modifying, either:
#   1. Re-run deploy.sh (will copy and reload nginx)
#   2. Manually: sudo cp nginx/pi-site.conf /etc/nginx/sites-available/pi-site && sudo nginx -t && sudo systemctl reload nginx

# Umami analytics dashboard subdomain
server {
    listen 80;
    server_name umami.rioedwards.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Preserve original host/IP info
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache_bypass $http_upgrade;
    }
}

# Main site - default server for all other requests
server {
    listen 80 default_server;
    server_name _;

    # Serve user-uploaded images directly from Docker volume
    # Bypasses Node.js entirely for best performance
    location /api/assets/images/ {
        alias /var/lib/docker/volumes/pi_site_prod_uploads/_data/;

        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;

        access_log off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        try_files $uri =404;
    }

    # Next.js image optimization - cache at nginx level
    # Images are optimized once by Node.js, then served from nginx cache
    location /_next/image {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        # Cache optimized images for 30 days
        proxy_cache nextjs_images;
        proxy_cache_valid 200 30d;
        proxy_cache_key $uri$is_args$args;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;

        # Debug header to verify caching
        add_header X-Cache-Status $upstream_cache_status;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy all other requests to Next.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Preserve original host/IP info (use Cloudflare's real client IP)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache_bypass $http_upgrade;

        # Disable buffering for streaming (SSE for /stats page)
        proxy_buffering off;
        proxy_set_header X-Accel-Buffering no;
    }
}
