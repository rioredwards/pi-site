name: CI & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from GitHub UI
  # Explicitly do NOT trigger on pull_request events

jobs:
  ci:
    name: Lint, Typecheck & Build
    runs-on: [self-hosted, linux, arm64]
    # Security: Only run if:
    # 1. This is a push event (not a PR) OR a manual workflow_dispatch
    # 2. The actor is the repository owner (you)
    # 3. The repository is not a fork
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.actor == github.repository_owner &&
      !github.event.repository.fork

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Additional security: only checkout from the main repository
        with:
          ref: ${{ github.ref }}

      - name: Verify repository ownership
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Owner: ${{ github.repository_owner }}"
          if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
            echo "‚ùå Security check failed: Actor is not repository owner"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Build
        env:
          NEXT_PUBLIC_SAFE_KEY: ci-placeholder
          NEXT_PUBLIC_SITE_URL: http://localhost:3000
        run: npm run build

  deploy:
    name: Deploy to Pi
    runs-on: self-hosted
    needs: ci

    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.actor == github.repository_owner &&
      !github.event.repository.fork

    steps:
      - name: Run production update
        run: ~/pi-site/scripts/update-prod.sh
