name: CI & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from GitHub UI
  # Explicitly do NOT trigger on pull_request events
  # Use [skip ci] in commit message to skip for minor changes

jobs:
  deploy:
    name: Lint, Typecheck & Deploy
    runs-on: [self-hosted, linux, arm64]
    # Security: Only run if:
    # 1. This is a push event (not a PR) OR a manual workflow_dispatch
    # 2. The actor is the repository owner (you)
    # 3. The repository is not a fork
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.actor == github.repository_owner &&
      !github.event.repository.fork

    steps:
      - name: Fix git config for self-hosted runner
        run: |
          mkdir -p "$HOME"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout code
        uses: actions/checkout@v4
        # Additional security: only checkout from the main repository
        with:
          ref: ${{ github.ref }}

      - name: Verify repository ownership
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Owner: ${{ github.repository_owner }}"
          if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
            echo "‚ùå Security check failed: Actor is not repository owner"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          # No cache - self-hosted runner uses local npm cache

      - name: Install dependencies
        run: npm install  # Use install (not ci) to preserve local node_modules cache

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      # Skip build - Docker will build during deploy

      - name: Deploy
        run: ~/pi-site/scripts/update-prod.sh
