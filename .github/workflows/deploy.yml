name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering from GitHub UI
  # Explicitly do NOT trigger on pull_request events

jobs:
  deploy:
    name: Deploy to Pi
    # Use self-hosted runner on the Raspberry Pi
    # This avoids needing to expose SSH or configure port forwarding
    runs-on: self-hosted
    
    # Security: Only run if:
    # 1. This is a push event (not a PR) OR a manual workflow_dispatch
    # 2. The actor is the repository owner (you)
    # 3. The repository is not a fork
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      github.actor == github.repository_owner &&
      !github.event.repository.fork
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # Additional security: only checkout from the main repository
        with:
          ref: ${{ github.ref }}
      
      - name: Verify repository ownership
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Owner: ${{ github.repository_owner }}"
          if [ "${{ github.actor }}" != "${{ github.repository_owner }}" ]; then
            echo "❌ Security check failed: Actor is not repository owner"
            exit 1
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate Prisma client
        run: |
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 npx prisma generate 2>&1 | (grep -v '404 Not Found' || true) || echo 'Prisma generate failed, using existing client'
      
      - name: Test build
        run: npm run build
      
      - name: Deploy application
        run: |
          cd ~/pi-site
          git fetch origin
          git checkout main
          git pull origin main
          zsh scripts/check-system-deps.sh --install || echo '⚠️  System dependency check skipped'
          npm install --ignore-scripts
          mkdir -p public/images
          chmod 755 public/images
          chown -R $(whoami):$(whoami) public/images
          rm -rf .next
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1 npx prisma generate 2>&1 | (grep -v '404 Not Found' || true) || echo 'Prisma generate failed, using existing client'
          npm run build || (echo 'Build failed, checking Prisma client...' && ls -la node_modules/@prisma/client && npm run build)
          pm2 delete pi-site 2>/dev/null || true
          pm2 start ecosystem.config.js
          pm2 save
      
      - name: Deployment status
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "The app should be running on http://localhost:3000"
      
      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."
