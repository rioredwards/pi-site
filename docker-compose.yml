# Base configuration - shared across all environments
# Environment-specific settings should go in:
#   - docker-compose.override.yml (dev - auto-loaded)
#   - docker-compose.prod.yml (production)
#   - docker-compose.staging.yml (staging)

services:
  web:
    build:
      context: .
      args:
        NEXT_PUBLIC_SAFE_KEY: ${NEXT_PUBLIC_SAFE_KEY}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL}
    ports:
      - '3000:3000'
    depends_on:
      db:
        condition: service_healthy
      ai-img-validator:
        condition: service_started
      system-profiler:
        condition: service_started
    labels:
      - "com.rioredwards.stack=pi-site"

  system-profiler:
    build: ./system-profiler
    labels:
      - "com.rioredwards.stack=pi-site"

  ai-img-validator:
    image: pi-site/ai-img-validator:stable
    labels:
      - "com.rioredwards.stack=pi-site"

  db:
    image: postgres:17
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10
    labels:
      - "com.rioredwards.stack=pi-site"

  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    depends_on:
      db:
        condition: service_healthy
    labels:
      - "com.rioredwards.stack=pi-site"
