services:
  app:
    platform: linux/arm64
    image: pi-site:latest
    container_name: pi-site
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined

    ports:
      - "3000:3000"

    env_file:
      - .env

    volumes:
      # Persist database
      - ./prisma:/app/prisma
      # Persist uploaded images
      - ./public/images:/app/public/images

    networks:
      - pi-site-network

    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

networks:
  pi-site-network:
    driver: bridge
