# Production configuration
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  web:
    env_file:
      - .env.prod
    environment:
      NODE_ENV: production
      HOSTNAME: "0.0.0.0"
    volumes:
      - uploads_data:/data/uploads/images
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 768M
        reservations:
          cpus: "0.5"
          memory: 384M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  system-profiler:
    env_file:
      - .env.prod
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /:/host/root:ro
      - /var/lib/docker:/host/var/lib/docker:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8787"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  ai-img-validator:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1536M
        reservations:
          cpus: "0.5"
          memory: 768M
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  db:
    env_file:
      - .env.prod
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  umami:
    ports:
      - "127.0.0.1:3001:3000"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/umami
      APP_SECRET: ${UMAMI_APP_SECRET}
      TZ: America/Los_Angeles
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test:
        ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  postgres_data:
    name: pi_site_prod_data
  uploads_data:
    name: pi_site_prod_uploads
